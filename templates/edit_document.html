{% load static %}
{% include "header.html" %}

<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen">

<main class="max-w-6xl mx-auto py-10 px-4">

  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8">

    <!-- ================= HEADER ================= -->
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold mb-2">
        ‚úèÔ∏è Edit Document
      </h1>

      <p class="text-gray-500 dark:text-gray-400">
        {{ document.get_doc_type_display }} ‚Ä¢ Uploaded on
        {{ document.created_at|date:"M d, Y" }}
      </p>

      <div class="mt-4">
        <span class="px-4 py-2 rounded-full text-sm font-medium
          {% if document.user_edited_data %}
            bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300
          {% else %}
            bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-300
          {% endif %}">
          {% if document.user_edited_data %}
            Editing previously saved data
          {% else %}
            Editing extracted data
          {% endif %}
        </span>
      </div>
    </div>

    <!-- ================= ERROR BOX ================= -->
    {% if form.errors %}
    <div class="mb-6 p-4 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300">
      <strong>Please correct the following:</strong>
      <ul class="list-disc list-inside mt-2">
        {% for field, errors in form.errors.items %}
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
    {% endif %}

    {% if document.user_edited_data or document.extracted_data %}

      {% if document.user_edited_data %}
        {{ document.user_edited_data|json_script:"document-data" }}
      {% else %}
        {{ document.extracted_data|json_script:"document-data" }}
      {% endif %}

      <!-- ================= TABS ================= -->
      <div class="border-b mb-6 flex gap-6">
        <button id="visual-tab" class="tab-btn active">üé® Visual Editor</button>
        <button id="json-tab" class="tab-btn">‚öôÔ∏è JSON Editor</button>
      </div>

      <!-- ================= VISUAL EDITOR ================= -->
      <div id="visual-editor">

        <form id="visual-form" method="POST">
          {% csrf_token %}
          <input type="hidden" name="user_edited_data" id="json-output">

          <!-- Page Selector -->
          <div class="mb-6">
            <label class="block text-sm font-semibold mb-2">Select Page</label>
            <select id="page-selector"
              class="w-full p-3 border rounded-xl dark:bg-gray-700 dark:border-gray-600">
            </select>
          </div>

          <!-- Search Field -->
          <div class="mb-6">
            <input type="text" id="field-search"
              placeholder="üîç Search field..."
              class="w-full p-3 border rounded-xl dark:bg-gray-700 dark:border-gray-600">
          </div>

          <!-- Fields Container -->
          <div id="fields-container" class="space-y-4"></div>

          <!-- Add Button -->
          <button type="button" id="add-field-btn"
            class="mt-6 w-full py-3 bg-green-600 hover:bg-green-700 text-white rounded-xl font-semibold transition">
            ‚ûï Add New Field
          </button>
        </form>
      </div>

      <!-- ================= JSON EDITOR ================= -->
      <div id="json-editor" class="hidden">
        <form method="POST">
          {% csrf_token %}
          <label class="block font-semibold mb-2">Edit JSON Data</label>
          {{ form.user_edited_data }}
          <p class="text-sm text-gray-500 mt-2">
            Ensure valid JSON format.
          </p>
        </form>
      </div>

    {% else %}

      <div class="text-center py-16 text-gray-400">
        üì≠ No extracted data available.
      </div>

    {% endif %}

    <!-- ================= FOOTER ACTIONS ================= -->
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-10 pt-6 border-t dark:border-gray-700">

      <a href="{% url 'core:document_detail' document.pk %}"
        class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-xl transition">
        ‚Üê Cancel
      </a>

      <div class="flex gap-4">
        <button type="button" onclick="formatJSON()"
          class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl transition">
          üîß Format JSON
        </button>

        <button type="submit" form="visual-form"
          class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-semibold transition">
          üíæ Save Changes
        </button>
      </div>
    </div>

  </div>
</main>

<style>
.tab-btn {
  padding: 10px 20px;
  font-weight: 600;
  color: gray;
  border-bottom: 2px solid transparent;
}
.tab-btn.active {
  color: rgb(79 70 229);
  border-color: rgb(79 70 229);
}
.field-row {
  display: flex;
  gap: 12px;
}
.field-input {
  flex: 1;
}
.delete-btn {
  background: #ef4444;
  color: white;
  border-radius: 8px;
  padding: 10px 14px;
}
.hidden { display:none; }
</style>

<script>
let documentData = {};
const jsonElement = document.getElementById("document-data");
if (jsonElement) {
  documentData = JSON.parse(jsonElement.textContent);
}

document.addEventListener("DOMContentLoaded", () => {
  initializeVisualEditor();
  switchTab("visual");

  document.getElementById("visual-tab").onclick = () => switchTab("visual");
  document.getElementById("json-tab").onclick = () => switchTab("json");
  document.getElementById("add-field-btn").onclick = addFieldRow;
  document.getElementById("field-search").onkeyup = filterFields;
});

function switchTab(tab) {
  document.getElementById("visual-editor").classList.toggle("hidden", tab !== "visual");
  document.getElementById("json-editor").classList.toggle("hidden", tab !== "json");
  document.getElementById("visual-tab").classList.toggle("active", tab === "visual");
  document.getElementById("json-tab").classList.toggle("active", tab === "json");
}

function initializeVisualEditor() {
  const selector = document.getElementById("page-selector");
  selector.innerHTML = "";

  Object.keys(documentData).forEach(page => {
    if (!page.startsWith("_")) {
      const opt = document.createElement("option");
      opt.value = page;
      opt.textContent = "Page " + page.split("_")[1];
      selector.appendChild(opt);
    }
  });

  loadPageData(selector.value);
  selector.onchange = () => loadPageData(selector.value);
}

function loadPageData(page) {
  const container = document.getElementById("fields-container");
  container.innerHTML = "";

  const data = documentData[page] || {};
  Object.keys(data).forEach(key => {
    if (key !== "_metadata")
      addFieldRow(key, data[key]);
  });

  updateJSON();
}

function addFieldRow(name="", value="") {
  const container = document.getElementById("fields-container");
  const row = document.createElement("div");
  row.className = "field-row";

  row.innerHTML = `
    <input class="field-input p-3 border rounded-xl dark:bg-gray-700 dark:border-gray-600"
      placeholder="Field Name" value="${name}">
    <input class="field-input p-3 border rounded-xl dark:bg-gray-700 dark:border-gray-600"
      placeholder="Field Value" value="${value}">
    <button type="button" class="delete-btn">üóë</button>
  `;

  row.querySelector(".delete-btn").onclick = () => {
    row.remove();
    updateJSON();
  };

  row.querySelectorAll("input").forEach(i => i.oninput = updateJSON);
  container.appendChild(row);
}

function updateJSON() {
  const page = document.getElementById("page-selector").value;
  const rows = document.querySelectorAll(".field-row");
  const updated = {};

  rows.forEach(row => {
    const name = row.children[0].value.trim();
    const value = row.children[1].value;
    if (name) updated[name] = value;
  });

  documentData[page] = updated;
  const json = JSON.stringify(documentData, null, 2);

  document.getElementById("json-output").value = json;
  const txt = document.querySelector('textarea[name="user_edited_data"]');
  if (txt) txt.value = json;
}

function formatJSON() {
  const txt = document.querySelector('textarea[name="user_edited_data"]');
  try {
    const parsed = JSON.parse(txt.value);
    txt.value = JSON.stringify(parsed, null, 2);
    documentData = parsed;
    initializeVisualEditor();
  } catch {
    alert("Invalid JSON format!");
  }
}

function filterFields() {
  const query = this.value.toLowerCase();
  document.querySelectorAll(".field-row").forEach(row => {
    const name = row.children[0].value.toLowerCase();
    row.style.display = name.includes(query) ? "flex" : "none";
  });
}
</script>

</body>
{% include "footer.html" %}