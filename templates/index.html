{% load static %}
<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASK_ME - Document Intelligence Chatbot</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          keyframes: {
            "dot-flash": {
              "0%": { opacity: 0.2, transform: "translateY(0.25rem)" },
              "50%": { opacity: 1, transform: "translateY(0)" },
              "100%": { opacity: 0.2, transform: "translateY(0.25rem)" },
            },
            "fade-in-up": {
              "0%": { opacity: 0, transform: "translateY(8px)" },
              "100%": { opacity: 1, transform: "translateY(0)" },
            },
            "fade-in": {
              "0%": { opacity: 0 },
              "100%": { opacity: 1 },
            },
          },
          animation: {
            "dot-flash": "dot-flash 1s ease-in-out infinite",
            "fade-in-up": "fade-in-up 220ms ease-out both",
            "fade-in": "fade-in 300ms ease-out both",
          },
        },
      },
    };
  </script>

  <style>
    .chat-scrollbar::-webkit-scrollbar {
      width: 8px;
    }
    .chat-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(100, 100, 100, 0.2);
      border-radius: 8px;
    }
    .quick-reply {
      white-space: nowrap;
    }
    .input-shadow:focus {
      box-shadow: 0 6px 18px rgba(2, 6, 23, 0.25);
    }
    .document-preview {
      max-height: 200px;
      overflow-y: auto;
    }
    .field-row {
      transition: all 0.2s ease;
    }
    .field-row:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center p-4">
  <!-- Main Container -->
  <main class="w-full max-w-4xl mx-auto">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden grid grid-rows-[auto_1fr_auto] h-[90vh] md:h-[85vh]">
      
      <!-- Header -->
      <header class="flex items-center justify-between gap-3 p-4 border-b dark:border-gray-700">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold">
            AM
          </div>
          <div>
            <div class="font-semibold">ASK_ME - Document Intelligence</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">Upload, Extract, Query</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <!-- Dark mode toggle -->
          <button id="darkToggle" aria-label="Toggle dark mode" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 4.5a.75.75 0 01.75.75V7a.75.75 0 01-1.5 0V5.25A.75.75 0 0110 4.5zM10 13a3 3 0 100-6 3 3 0 000 6z" />
              <path d="M10 1.75a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0V2.5A.75.75 0 0110 1.75zM10 15.5a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5A.75.75 0 0110 15.5zM3.22 3.22a.75.75 0 011.06 0l.354.353a.75.75 0 01-1.06 1.06L3.22 4.28a.75.75 0 010-1.06zM15.36 15.36a.75.75 0 011.06 0l.354.353a.75.75 0 01-1.06 1.06l-.354-.353a.75.75 0 010-1.06zM3.22 16.78a.75.75 0 010-1.06l.353-.354a.75.75 0 011.06 1.06l-.353.354a.75.75 0 01-1.06 0zM15.36 4.64a.75.75 0 010 1.06l-.354.354a.75.75 0 11-1.06-1.06l.354-.354a.75.75 0 011.06 0z" />
            </svg>
          </button>

          <!-- File Upload -->
          <button id="fileUploadBtn" title="Upload document" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
            </svg>
          </button>

          <!-- Microphone -->
          <button id="micBtn" title="Toggle microphone" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 2a2.5 2.5 0 00-2.5 2.5V9a2.5 2.5 0 005 0V4.5A2.5 2.5 0 0010 2z" />
              <path d="M5 10a5 5 0 0010 0h-1.5a3.5 3.5 0 01-7 0H5zM10 15v3" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Chat history -->
      <section id="chatHistory" class="chat-scrollbar p-4 overflow-auto space-y-4 bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-800">
        <!-- Welcome message -->
        <div id="welcome" class="text-center text-sm text-gray-500 dark:text-gray-400">
          Welcome to ASK_ME! Upload a document to extract information or ask me anything.
        </div>
      </section>

      <!-- Input area -->
      <footer class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800">
        <div id="errorBanner" class="hidden mb-2 rounded-md bg-red-50 dark:bg-red-900/30 px-3 py-2 text-sm text-red-700 dark:text-red-300"></div>

        <!-- Quick replies -->
        <div id="quickReplies" class="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
          <button class="quick-reply px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-sm rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            Upload document
          </button>
          <button class="quick-reply px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-sm rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            Show extracted data
          </button>
          <button class="quick-reply px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-sm rounded-full hover:bg-gray-200 dark:hover:bg-gray-600">
            Help
          </button>
        </div>

        <div class="flex gap-2 items-end">
          <textarea
            id="messageInput"
            rows="1"
            placeholder="Ask about your document or type a message..."
            class="flex-1 resize-none rounded-xl border dark:border-gray-700 px-4 py-3 focus:outline-none input-shadow bg-gray-50 dark:bg-gray-900 text-sm"
          ></textarea>

          <button
            id="sendBtn"
            class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-medium disabled:opacity-60"
            aria-label="Send message"
          >
            Send
          </button>
        </div>

        <!-- Typing indicator -->
        <div id="typingIndicator" class="mt-3 hidden text-sm text-gray-500 dark:text-gray-400">
          <span class="inline-flex items-center gap-2">
            <strong>Bot is typing</strong>
            <span class="inline-flex items-end gap-1">
              <span class="w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-300 inline-block animate-dot-flash"></span>
              <span class="w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-300 inline-block animate-dot-flash" style="animation-delay: 0.15s"></span>
              <span class="w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-300 inline-block animate-dot-flash" style="animation-delay: 0.3s"></span>
            </span>
          </span>
        </div>
      </footer>
    </div>
  </main>

  <!-- Document Upload Modal -->
  <div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-4 p-6 animate-fade-in-up">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">Upload Document</h3>
        <button id="closeUploadModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      
      <div class="mb-4">
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Supported formats: PDF, JPG, PNG, TXT</p>
        <div id="dropZone" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          <p class="text-sm text-gray-600 dark:text-gray-400">Drag & drop files here or click to browse</p>
          <input type="file" id="fileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.txt" />
        </div>
      </div>
      
      <div class="flex justify-end gap-2">
        <button id="cancelUpload" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
          Cancel
        </button>
        <button id="processDocument" class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50" disabled>
          Process Document
        </button>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script>
    (function () {
      // Elements
      const chatHistory = document.getElementById("chatHistory");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const typingIndicator = document.getElementById("typingIndicator");
      const errorBanner = document.getElementById("errorBanner");
      const quickReplies = document.getElementById("quickReplies");
      const darkToggle = document.getElementById("darkToggle");
      const micBtn = document.getElementById("micBtn");
      const fileUploadBtn = document.getElementById("fileUploadBtn");
      const uploadModal = document.getElementById("uploadModal");
      const closeUploadModal = document.getElementById("closeUploadModal");
      const cancelUpload = document.getElementById("cancelUpload");
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const processDocument = document.getElementById("processDocument");

      let isDark = false;
      const preferredDark = localStorage.getItem("chat-dark");
      if (preferredDark === "1") {
        document.documentElement.classList.add("dark");
        isDark = true;
      }

      // Document data storage
      let documentData = null;
      let extractedFields = {};

      // Utility: auto-scroll to bottom smoothly
      function scrollToBottom() {
        chatHistory.scrollTo({
          top: chatHistory.scrollHeight,
          behavior: "smooth",
        });
      }

      // Utility: create message element
      function createMessageEl({ text, who = "bot", timestamp = Date.now(), html = null }) {
        const wrapper = document.createElement("div");
        wrapper.className = "flex " + (who === "user" ? "justify-end" : "justify-start") + " px-1";
        
        const bubble = document.createElement("div");
        bubble.className = [
          "max-w-[85%] break-words text-sm px-4 py-3 rounded-2xl shadow-sm",
          "animate-fade-in-up",
        ].join(" ");

        if (who === "user") {
          bubble.classList.add("bg-indigo-600", "text-white", "rounded-br-none");
        } else {
          bubble.classList.add("bg-gray-100", "dark:bg-gray-700", "text-gray-900", "dark:text-gray-100", "rounded-bl-none");
        }

        if (html) {
          bubble.innerHTML = html;
        } else {
          bubble.innerText = text;
        }

        wrapper.appendChild(bubble);
        return wrapper;
      }

      // Create document extraction form
      function createExtractionForm(fields) {
        let html = `
          <div class="mb-3">
            <h3 class="font-semibold text-base mb-2">Extracted Document Information</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Review and edit the extracted information below:</p>
          </div>
          <div class="space-y-3">
        `;

        Object.entries(fields).forEach(([field, value]) => {
          html += `
            <div class="field-row flex items-center gap-2 p-2 rounded-md">
              <label class="w-1/3 text-sm font-medium text-gray-700 dark:text-gray-300">${field.replace(/_/g, ' ').toUpperCase()}:</label>
              <input type="text" 
                     class="flex-1 border border-gray-300 dark:border-gray-600 rounded px-3 py-1.5 text-sm bg-white dark:bg-gray-800" 
                     value="${value}" 
                     data-field="${field}" />
            </div>
          `;
        });

        html += `
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="cancelEdit" class="px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
              Cancel
            </button>
            <button id="saveDocumentData" class="px-3 py-1.5 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
              Save Data
            </button>
          </div>
        `;

        return html;
      }

      // Show typing indicator
      function showTyping(show = true) {
        typingIndicator.classList.toggle("hidden", !show);
        scrollToBottom();
      }

      // Show error message
      function showError(msg) {
        errorBanner.innerText = msg;
        errorBanner.classList.remove("hidden");
        setTimeout(() => errorBanner.classList.add("hidden"), 6000);
      }

      // Send message flow
      async function sendMessage(text, opts = {}) {
        const trimmed = String(text || "").trim();
        if (!trimmed) return;

        // add user message immediately
        const userMsg = createMessageEl({ text: trimmed, who: "user" });
        chatHistory.appendChild(userMsg);
        scrollToBottom();

        // clear input
        messageInput.value = "";
        messageInput.focus();

        // show typing
        showTyping(true);

        // Check if we have document data to include in the query
        const payload = { message: trimmed };
        if (documentData) {
          payload.document_data = documentData;
        }

        // call backend
        try {
          const res = await fetch("/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!res.ok) {
            let errText = `API Error: ${res.status} ${res.statusText}`;
            try {
              const json = await res.json();
              if (json && json.error) errText = json.error;
            } catch (e) {}
            throw new Error(errText);
          }

          const data = await res.json();
          const botText = (data && (data.reply || data.message || data.text)) || "No response";

          // append bot message
          const botMsg = createMessageEl({ text: botText, who: "bot" });
          chatHistory.appendChild(botMsg);
          showTyping(false);
          scrollToBottom();
        } catch (err) {
          showTyping(false);
          showError(err.message || "Failed to reach the chat API.");
          const botMsg = createMessageEl({
            text: "Sorry â€” I could not process that. Please try again.",
            who: "bot",
          });
          chatHistory.appendChild(botMsg);
          scrollToBottom();
        }
      }

      // Process uploaded document
      async function processUploadedDocument(file) {
        const formData = new FormData();
        formData.append('file', file);

        showTyping(true);

        try {
          const res = await fetch("/api/upload", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) {
            throw new Error(`Upload failed: ${res.status} ${res.statusText}`);
          }

          const data = await res.json();
          
          if (data && data.extracted_fields) {
            extractedFields = data.extracted_fields;
            
            // Create and show the extraction form
            const formHtml = createExtractionForm(extractedFields);
            const botMsg = createMessageEl({ 
              html: formHtml, 
              who: "bot" 
            });
            
            chatHistory.appendChild(botMsg);
            scrollToBottom();
            
            // Add event listeners for the form buttons
            document.getElementById('saveDocumentData').addEventListener('click', saveDocumentData);
            document.getElementById('cancelEdit').addEventListener('click', () => {
              chatHistory.removeChild(botMsg);
            });
          } else {
            throw new Error("No extracted data received");
          }
        } catch (err) {
          showError(err.message || "Failed to process the document.");
          const botMsg = createMessageEl({
            text: "Sorry, I couldn't extract information from that document. Please try another file.",
            who: "bot",
          });
          chatHistory.appendChild(botMsg);
        } finally {
          showTyping(false);
          closeUploadModal.click();
        }
      }

      // Save document data
      function saveDocumentData() {
        // Update extractedFields with any edits
        const inputs = document.querySelectorAll('input[data-field]');
        inputs.forEach(input => {
          const field = input.getAttribute('data-field');
          extractedFields[field] = input.value;
        });

        // Store the data
        documentData = extractedFields;
        
        // Show confirmation message
        const botMsg = createMessageEl({
          text: "Document data saved successfully! You can now ask questions about your document.",
          who: "bot",
        });
        chatHistory.appendChild(botMsg);
        scrollToBottom();
      }

      // Event Listeners

      // handle Send button
      sendBtn.addEventListener("click", () => sendMessage(messageInput.value));

      // handle Enter to send, Shift+Enter for newline
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage(messageInput.value);
        }
      });

      // Quick replies click
      quickReplies.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        
        const text = btn.innerText;
        if (text === "Upload document") {
          fileUploadBtn.click();
        } else if (text === "Show extracted data" && documentData) {
          const fieldsText = Object.entries(documentData)
            .map(([key, value]) => `${key}: ${value}`)
            .join('\n');
          sendMessage(`Here's the extracted data:\n${fieldsText}`);
        } else {
          sendMessage(text);
        }
      });

      // Dark mode toggle
      darkToggle.addEventListener("click", () => {
        isDark = !isDark;
        if (isDark) {
          document.documentElement.classList.add("dark");
          localStorage.setItem("chat-dark", "1");
        } else {
          document.documentElement.classList.remove("dark");
          localStorage.setItem("chat-dark", "0");
        }
      });

      // File upload functionality
      fileUploadBtn.addEventListener("click", () => {
        uploadModal.classList.remove("hidden");
      });

      [closeUploadModal, cancelUpload].forEach(btn => {
        btn.addEventListener("click", () => {
          uploadModal.classList.add("hidden");
          fileInput.value = "";
          processDocument.disabled = true;
        });
      });

      dropZone.addEventListener("click", () => {
        fileInput.click();
      });

      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("border-indigo-400", "bg-indigo-50", "dark:bg-indigo-900/20");
      });

      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("border-indigo-400", "bg-indigo-50", "dark:bg-indigo-900/20");
      });

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-indigo-400", "bg-indigo-50", "dark:bg-indigo-900/20");
        
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files;
          processDocument.disabled = false;
        }
      });

      fileInput.addEventListener("change", () => {
        processDocument.disabled = !fileInput.files.length;
      });

      processDocument.addEventListener("click", () => {
        if (fileInput.files.length) {
          processUploadedDocument(fileInput.files[0]);
        }
      });

      // Microphone / Speech-to-text
      let recognition = null;
      let listening = false;
      if ("webkitSpeechRecognition" in window || "SpeechRecognition" in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = "en-IN";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.addEventListener("result", (ev) => {
          const transcript = Array.from(ev.results)
            .map((r) => r[0])
            .map((x) => x.transcript)
            .join("");
          messageInput.value = transcript;
        });

        recognition.addEventListener("end", () => {
          listening = false;
          micBtn.classList.remove("bg-red-100", "dark:bg-red-900/50");
        });
      } else {
        micBtn.title = "Speech recognition not supported in this browser";
        micBtn.classList.add("opacity-40", "cursor-not-allowed");
      }

      micBtn.addEventListener("click", () => {
        if (!recognition) return;
        if (!listening) {
          try {
            recognition.start();
            listening = true;
            micBtn.classList.add("bg-red-100", "dark:bg-red-900/50");
          } catch (e) {
            console.warn(e);
          }
        } else {
          recognition.stop();
          listening = false;
          micBtn.classList.remove("bg-red-100", "dark:bg-red-900/50");
        }
      });

      // For accessibility: focus input when anywhere in chat clicked
      chatHistory.addEventListener("click", () => messageInput.focus());

      // Add initial example bot messages
      function initWelcome() {
        const botIntro = createMessageEl({
          text: "Hi! I'm ASK_ME, your document intelligence assistant. Upload documents like Aadhar cards, invoices, or forms, and I'll extract the information for you to review. Then you can ask me questions about your documents!",
          who: "bot",
        });
        chatHistory.appendChild(botIntro);
        scrollToBottom();
      }
      initWelcome();

      // Resize textarea auto-grow
      function autoResizeTA(el) {
        el.style.height = "auto";
        el.style.height = el.scrollHeight + "px";
      }
      messageInput.addEventListener("input", () => autoResizeTA(messageInput));
      autoResizeTA(messageInput);

      // Hide quick-replies if mobile small view
      function adaptQuickReplies() {
        if (window.innerWidth < 420) quickReplies.classList.add("hidden");
        else quickReplies.classList.remove("hidden");
      }
      window.addEventListener("resize", adaptQuickReplies);
      adaptQuickReplies();
    })();
  </script>
</body>
</html>