{% load static %} {% include "header.html" %}

  <body
    class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center p-4 transition-colors duration-300"
  >
    <main class="w-full max-w-4xl mx-auto">
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden grid grid-rows-[auto_1fr_auto] h-[90vh] md:h-[85vh]"
      >
      
        <header
          class="flex items-center justify-between gap-3 p-4 border-b dark:border-gray-700"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-11 h-11 rounded-lg overflow-hidden flex items-center justify-center"
            >
              <img
                src="{% static 'img/ASK_ME_Logo.png' %}"
                alt="Logo"
                class="w-full h-full object-cover"
              />
            </div>
            <div>
              <div class="font-semibold">
                ASK_ME - Secure & Smart Document Assistant
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-400">
              </div>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button
              id="darkToggle"
              aria-label="Toggle dark mode"
              class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition"
            >
              <svg
                id="darkIcon"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 hidden"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M21.752 15.002A9 9 0 1112.998 3.25a7 7 0 008.754 11.752z"
                />
              </svg>
              <svg
                id="lightIcon"
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 hidden"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="5" />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 1v2m0 18v2m11-11h-2M3 12H1m16.95 7.95l-1.41-1.41M6.46 6.46 5.05 5.05m13.9 0-1.41 1.41M6.46 17.54l-1.41 1.41"
                />
              </svg>
            </button>

            <a
              href="{% url 'core:document_library' %}"
              title="Back to Document Library"
              class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition inline-flex items-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              üìÅ
            </a>
            
            <a
              href="{% url 'userprofile' %}"
              title="Back to Document Library"
              class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition inline-flex items-center gap-2"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              üòé
            </a>
            
            <button
              id="fileUploadBtn"
              title="Upload document"
              class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M12 12V4m0 8l3-3m-3 3L9 9"
                />
              </svg>
            </button>
          </div>
        </header>

        <div class="p-4">
          {% if messages %} {% for message in messages %}
          <div
            class="mb-2 p-2 rounded {{ message.tags }} bg-indigo-100 dark:bg-indigo-700 text-indigo-800 dark:text-indigo-100"
          >
            {{ message }}
          </div>
          {% endfor %} {% endif %}
        </div>

        <section
          id="chatHistory"
          class="flex-1 p-4 overflow-y-auto bg-gradient-to-b from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 space-y-4 scroll-smooth hide-scrollbar"
        >
          {% if field %}
          <div
            class="mb-4 p-4 rounded-lg border shadow-sm bg-gray-50 dark:bg-gray-800 border-gray-300 dark:border-gray-700"
          >
            <h3 class="font-semibold text-gray-700 dark:text-gray-100 mb-2">
              üîç Search Results for "<span class="text-indigo-600"
                >{{ field }}</span
              >"
            </h3>

            {% if error %}
            <div
              class="p-2 rounded bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300"
            >
              {{ error }}
            </div>
            {% elif results %}
            <div class="space-y-3">
              {% for result in results %}
              <div
                class="p-3 border border-gray-300 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 shadow-sm hover:shadow-md transition"
              >
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  <strong>Document ID:</strong> {{ result.document_id }}
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  <strong>Document Type:</strong> {{ result.doc_type }}
                </p>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                  <strong>Page:</strong> {{ result.page|title }}
                </p>

                <p
                  class="text-base font-medium mt-1 text-gray-900 dark:text-gray-100"
                >
                  <strong>{{ result.field|capfirst }}:</strong>
                </p>

                {% if result.extracted_value %}
                <p class="text-sm text-gray-600 dark:text-gray-400 ml-4">
                  <strong>Extracted:</strong> {{ result.extracted_value }}
                </p>
                {% endif %}

                {% if result.value %}
                <p
                  class="text-sm text-green-700 dark:text-green-400 ml-4 font-medium"
                >
                  <strong>Edited:</strong> {{ result.value }} ‚úèÔ∏è
                </p>
                {% endif %}

                {% if result.is_user_edited %}
                <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1 ml-4">
                  ‚ö†Ô∏è This field has been edited by you.
                </p>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <div
              class="p-4 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg"
            >
              No results found.
            </div>
            {% endif %}
          </div>
          {% endif %}

          <div
            id="welcome"
            class="text-center text-sm text-gray-500 dark:text-gray-400"
          >
            üîí Welcome to ASK_ME üìÇ
            <br />
            ‚ú® your secure assistant for personal and important documents üìù.
          </div>
        </section>

        <footer
          class="p-4 border-t dark:border-gray-700 bg-white dark:bg-gray-800"
        >
          <form
            method="get"
            action="{% url 'core:search_document_field' %}"
            class="flex gap-2 items-center mt-3"
          >
            <input
              type="text"
              name="q"
              placeholder="üîé Looking for a Details Just Type... "
              class="flex-1 rounded-lg border dark:border-gray-700 px-3 py-2 text-sm focus:outline-none bg-white dark:bg-gray-900"
              required
            />
            <button
              type="submit"
              class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium text-sm transition"
            >
              Search
            </button>
          </form>

          <div
            id="typingIndicator"
            class="mt-3 hidden text-sm text-gray-500 dark:text-gray-400"
          >
            <span class="inline-flex items-center gap-2">
              <strong>Bot is typing</strong>
              <span class="inline-flex items-end gap-1">
                <span
                  class="w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-300 inline-block animate-dot-flash"
                ></span>
                <span
                  class="w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-300 inline-block animate-dot-flash"
                  style="animation-delay: 0.15s"
                ></span>
                <span
                  class="w-2 h-2 rounded-full bg-gray-400 dark:bg-gray-300 inline-block animate-dot-flash"
                  style="animation-delay: 0.3s"
                ></span>
              </span>
            </span>
          </div>
        </footer>
      </div>
    </main>

    <div
      id="uploadModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md mx-4 p-6 animate-fade-in-up"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Upload Document</h3>
          <button
            id="closeUploadModal"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            ‚úñ
          </button>
        </div>

        <form
          method="POST"
          enctype="multipart/form-data"
          action="{% url 'core:upload' %}"
        >
          {% csrf_token %}
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
            Supported formats: PDF, JPG, PNG, TIFF
          </p>
          <div
            id="dropZone"
            class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-10 w-10 mx-auto text-gray-400 mb-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              />
            </svg>
            <p class="text-sm text-gray-600 dark:text-gray-400">
              Drag & drop files here or click to browse
            </p>
            <input
              type="file"
              name="file"
              id="fileInput"
              class="hidden"
              accept=".pdf,.jpg,.jpeg,.png,.tiff,.tif"
              required
            />
          </div>

          <label
            for="docType"
            class="block mt-4 mb-1 text-sm font-medium text-gray-700 dark:text-gray-300"
            >Document Type</label
          >
          <select
            name="doc_type"
            id="docType"
            class="w-full rounded-lg border dark:border-gray-700 p-2 bg-gray-50 dark:bg-gray-900"
          >
            <option value="aadhaar_card">Aadhaar Card</option>
            <option value="pan_card">PAN Card</option>
            <option value="driving_license">Driving License</option>
            <option value="passport">Passport</option>
            <option value="voter_id_card">Voter ID Card</option>
            <option value="vehicle_registration_certificate">Vehicle Registration Certificate</option>
            <option value="other_document">Other Document</option>
          </select>

          <div class="flex justify-end gap-2 mt-4">
            <button
              type="button"
              id="cancelUpload"
              class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition"
            >
              Process Document
            </button>
          </div>
        </form>
      </div>
    </div>

    {% include "footer.html" %}

    <script>
      const darkToggle = document.getElementById("darkToggle");
      const darkIcon = document.getElementById("darkIcon");
      const lightIcon = document.getElementById("lightIcon");

      const enableDark = () => {
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme", "dark");
        darkIcon.classList.add("hidden");
        lightIcon.classList.remove("hidden");
      };

      const disableDark = () => {
        document.documentElement.classList.remove("dark");
        localStorage.setItem("theme", "light");
        lightIcon.classList.add("hidden");
        darkIcon.classList.remove("hidden");
      };

      if (localStorage.getItem("theme") === "dark") {
        enableDark();
      } else {
        disableDark();
      }

      darkToggle.addEventListener("click", () => {
        if (document.documentElement.classList.contains("dark")) disableDark();
        else enableDark();
      });

      const uploadBtn = document.getElementById("fileUploadBtn");
      const uploadModal = document.getElementById("uploadModal");
      const closeModal = document.getElementById("closeUploadModal");
      const cancelBtn = document.getElementById("cancelUpload");
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");

      uploadBtn.onclick = () => uploadModal.classList.remove("hidden");
      closeModal.onclick = cancelBtn.onclick = () =>
        uploadModal.classList.add("hidden");
      dropZone.onclick = () => fileInput.click();
      fileInput.onchange = () => {
        dropZone.querySelector("p").textContent =
          fileInput.files[0]?.name || "Drag & drop files here or click to browse";
      };

      document.querySelector("#chatHistory").scrollTo({
        top: document.querySelector("#chatHistory").scrollHeight,
        behavior: "smooth",
      });

      document.querySelectorAll(".quick-reply").forEach((btn) => {
        btn.addEventListener("click", () =>
          uploadModal.classList.remove("hidden")
        );
      });
    </script>
  </body>
</html>

